<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Motion Factory Manager</title>
    
    <!-- PWA Tags -->
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- Scripts -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #f8fafc;
            margin: 0;
            padding: 0;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        input[type="date"] { min-height: 38px; }
    </style>
</head>
<body class="text-slate-900 antialiased">
    <div id="root"></div>

    <!-- Firebase SDKs loaded via Compat layer -->
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore-compat.js"></script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- FIREBASE CONFIGURATION ---
        // Replace the values below with the ones from your Firebase Console
        const firebaseConfig = {
    apiKey: "AIzaSyBYKkA8fINDE7i-BoBHZFuhscnAPelphTw",
    authDomain: "mf-exp.firebaseapp.com",
    projectId: "mf-exp",
    storageBucket: "mf-exp.firebasestorage.app",
    messagingSenderId: "573599991150",
    appId: "1:573599991150:web:cd04a5a5ea5f3d1a806d7f",
    measurementId: "G-V4FVRXMWGQ"
  };

        const appId = 'motion-factory-ledger';

        // Initialize Firebase
        if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY") {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
        }

        const auth = firebase.apps.length ? firebase.auth() : null;
        const db = firebase.apps.length ? firebase.firestore() : null;

        const Icon = ({ name, size = 16, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} className={className} style={{ width: size, height: size }}></i>;
        };

        function App() {
            const [user, setUser] = useState(null);
            const [transactions, setTransactions] = useState([]);
            const [status, setStatus] = useState('connecting');
            const [toast, setToast] = useState(null);
            const [deleteConfirm, setDeleteConfirm] = useState(null);

            const [expForm, setExpForm] = useState({ date: new Date().toISOString().split('T')[0], note: '', amtJaimin: '', amtKamal: '' });
            const [incForm, setIncForm] = useState({ date: new Date().toISOString().split('T')[0], note: '', amtJaimin: '', amtKamal: '' });

            useEffect(() => {
                if (!auth) {
                    setStatus('error');
                    return;
                }

                const initAuth = async () => {
                    try {
                        // Check if running in specialized environment with token, otherwise use anonymous
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await auth.signInWithCustomToken(__initial_auth_token);
                        } else {
                            await auth.signInAnonymously();
                        }
                    } catch (err) {
                        console.error("Auth error:", err);
                        setStatus('offline');
                    }
                };
                initAuth();
                const unsubscribe = auth.onAuthStateChanged((u) => {
                    setUser(u);
                    if(u) setStatus('online');
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || !db) return;
                const path = `artifacts/${appId}/public/data/ledger`;
                const unsubscribe = db.collection(path)
                    .onSnapshot((snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setTransactions(data.sort((a, b) => new Date(b.date) - new Date(a.date)));
                    }, (error) => {
                        console.error("Firestore error:", error);
                        triggerToast("Sync Error");
                    });
                return () => unsubscribe();
            }, [user]);

            const triggerToast = (msg) => {
                setToast(msg);
                setTimeout(() => setToast(null), 3000);
            };

            const submitEntry = async (type) => {
                if (!user || !db) return;
                const form = type === 'expense' ? expForm : incForm;
                const amtJ = parseFloat(form.amtJaimin) || 0;
                const amtK = parseFloat(form.amtKamal) || 0;

                if (!form.date || !form.note || (amtJ === 0 && amtK === 0)) {
                    triggerToast("Missing Details");
                    return;
                }

                try {
                    await db.collection(`artifacts/${appId}/public/data/ledger`).add({
                        date: form.date,
                        note: form.note,
                        amount: amtJ || amtK,
                        partner: amtJ > 0 ? 'Jaimin' : 'Kamal',
                        type,
                        timestamp: Date.now()
                    });

                    const reset = { date: new Date().toISOString().split('T')[0], note: '', amtJaimin: '', amtKamal: '' };
                    type === 'expense' ? setExpForm(reset) : setIncForm(reset);
                    triggerToast("Cloud Updated");
                } catch (e) {
                    triggerToast("Save Failed");
                }
            };

            const confirmDelete = async () => {
                if (!user || !deleteConfirm || !db) return;
                try {
                    await db.doc(`artifacts/${appId}/public/data/ledger/${deleteConfirm}`).delete();
                    setDeleteConfirm(null);
                    triggerToast("Deleted");
                } catch (e) {
                    triggerToast("Delete Failed");
                }
            };

            const totals = (type) => {
                const filtered = transactions.filter(t => t.type === type);
                return {
                    jaimin: filtered.filter(t => t.partner === 'Jaimin').reduce((s, t) => s + t.amount, 0),
                    kamal: filtered.filter(t => t.partner === 'Kamal').reduce((s, t) => s + t.amount, 0),
                    total: filtered.reduce((s, t) => s + t.amount, 0)
                };
            };

            const expT = totals('expense');
            const incT = totals('income');

            if (status === 'error' || (firebaseConfig.apiKey === "YOUR_API_KEY")) {
                return (
                    <div className="flex items-center justify-center min-h-screen p-6 text-center">
                        <div className="bg-white p-8 rounded-2xl shadow-xl border border-slate-200 max-w-sm">
                            <Icon name="alert-triangle" size={48} className="text-rose-500 mx-auto mb-4" />
                            <h2 className="text-xl font-bold mb-2">Setup Required</h2>
                            <p className="text-sm text-slate-500 mb-4">Please edit the "firebaseConfig" section in the code with your actual Firebase project details.</p>
                            <div className="text-[10px] bg-slate-100 p-2 rounded text-left font-mono break-all">
                                code line: 40-47
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen pb-12">
                    <header className="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b border-slate-200 h-14 flex items-center">
                        <div className="max-w-7xl mx-auto px-4 w-full flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <div className="w-8 h-8 bg-slate-900 rounded flex items-center justify-center">
                                    <Icon name="box" size={18} className="text-white" />
                                </div>
                                <h1 className="text-lg font-extrabold tracking-tighter">MOTION<span className="text-slate-400">FACTORY</span></h1>
                            </div>
                            <div className={`px-2 py-1 rounded-md border text-[10px] font-bold uppercase flex items-center gap-1.5 ${status === 'online' ? 'bg-emerald-50 border-emerald-100 text-emerald-600' : 'bg-rose-50 border-rose-100 text-rose-600'}`}>
                                <div className={`w-1.5 h-1.5 rounded-full ${status === 'online' ? 'bg-emerald-500 animate-pulse' : 'bg-rose-500'}`}></div>
                                {status === 'online' ? 'Cloud Live' : 'Connecting'}
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 mt-6 grid grid-cols-1 lg:grid-cols-2 gap-8">
                        {/* Expense Section */}
                        <div className="space-y-4">
                            <div className="flex justify-between items-end px-1">
                                <h2 className="text-sm font-black uppercase tracking-widest text-slate-400">Expenses</h2>
                                <div className="text-xl font-black text-rose-600">₹{expT.total.toLocaleString()}</div>
                            </div>
                            <div className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                                <div className="overflow-x-auto custom-scrollbar">
                                    <table className="w-full text-left text-sm">
                                        <thead className="bg-slate-50 border-b border-slate-200 text-[10px] font-bold uppercase text-slate-400">
                                            <tr>
                                                <th className="p-3">Entry</th>
                                                <th className="p-3 text-blue-600">Jaimin</th>
                                                <th className="p-3 text-purple-600">Kamal</th>
                                                <th className="p-3 w-10"></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr className="bg-rose-50/20 border-b border-rose-100/50">
                                                <td className="p-2 space-y-1">
                                                    <input type="date" className="w-full p-1.5 border rounded text-xs" value={expForm.date} onChange={e => setExpForm({...expForm, date: e.target.value})} />
                                                    <input type="text" placeholder="What for?" className="w-full p-1.5 border rounded text-xs" value={expForm.note} onChange={e => setExpForm({...expForm, note: e.target.value})} />
                                                </td>
                                                <td className="p-2 align-bottom"><input type="number" placeholder="0" className="w-full p-1.5 border rounded font-bold text-blue-600" value={expForm.amtJaimin} onChange={e => setExpForm({...expForm, amtJaimin: e.target.value, amtKamal: ''})} /></td>
                                                <td className="p-2 align-bottom"><input type="number" placeholder="0" className="w-full p-1.5 border rounded font-bold text-purple-600" value={expForm.amtKamal} onChange={e => setExpForm({...expForm, amtKamal: e.target.value, amtJaimin: ''})} /></td>
                                                <td className="p-2 align-bottom"><button onClick={() => submitEntry('expense')} className="bg-rose-600 text-white p-2 rounded-lg w-full flex justify-center"><Icon name="plus" /></button></td>
                                            </tr>
                                            {transactions.filter(t => t.type === 'expense').map(t => (
                                                <tr key={t.id} className="border-b border-slate-50 hover:bg-slate-50">
                                                    <td className="p-3"><div className="text-[10px] text-slate-400">{t.date}</div><div className="font-bold">{t.note}</div></td>
                                                    <td className="p-3 font-bold text-blue-600">{t.partner === 'Jaimin' ? `₹${t.amount}` : '-'}</td>
                                                    <td className="p-3 font-bold text-purple-600">{t.partner === 'Kamal' ? `₹${t.amount}` : '-'}</td>
                                                    <td className="p-3"><button onClick={() => setDeleteConfirm(t.id)} className="text-slate-300 hover:text-rose-500"><Icon name="trash-2" size={14} /></button></td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        {/* Income Section */}
                        <div className="space-y-4">
                            <div className="flex justify-between items-end px-1">
                                <h2 className="text-sm font-black uppercase tracking-widest text-slate-400">Income</h2>
                                <div className="text-xl font-black text-emerald-600">₹{incT.total.toLocaleString()}</div>
                            </div>
                            <div className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                                <div className="overflow-x-auto custom-scrollbar">
                                    <table className="w-full text-left text-sm">
                                        <thead className="bg-slate-50 border-b border-slate-200 text-[10px] font-bold uppercase text-slate-400">
                                            <tr>
                                                <th className="p-3">Entry</th>
                                                <th className="p-3 text-blue-600">Jaimin</th>
                                                <th className="p-3 text-purple-600">Kamal</th>
                                                <th className="p-3 w-10"></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr className="bg-emerald-50/20 border-b border-emerald-100/50">
                                                <td className="p-2 space-y-1">
                                                    <input type="date" className="w-full p-1.5 border rounded text-xs" value={incForm.date} onChange={e => setIncForm({...incForm, date: e.target.value})} />
                                                    <input type="text" placeholder="Source?" className="w-full p-1.5 border rounded text-xs" value={incForm.note} onChange={e => setIncForm({...incForm, note: e.target.value})} />
                                                </td>
                                                <td className="p-2 align-bottom"><input type="number" placeholder="0" className="w-full p-1.5 border rounded font-bold text-blue-600" value={incForm.amtJaimin} onChange={e => setIncForm({...incForm, amtJaimin: e.target.value, amtKamal: ''})} /></td>
                                                <td className="p-2 align-bottom"><input type="number" placeholder="0" className="w-full p-1.5 border rounded font-bold text-purple-600" value={incForm.amtKamal} onChange={e => setIncForm({...incForm, amtKamal: e.target.value, amtJaimin: ''})} /></td>
                                                <td className="p-2 align-bottom"><button onClick={() => submitEntry('income')} className="bg-emerald-600 text-white p-2 rounded-lg w-full flex justify-center"><Icon name="plus" /></button></td>
                                            </tr>
                                            {transactions.filter(t => t.type === 'income').map(t => (
                                                <tr key={t.id} className="border-b border-slate-50 hover:bg-slate-50">
                                                    <td className="p-3"><div className="text-[10px] text-slate-400">{t.date}</div><div className="font-bold">{t.note}</div></td>
                                                    <td className="p-3 font-bold text-blue-600">{t.partner === 'Jaimin' ? `₹${t.amount}` : '-'}</td>
                                                    <td className="p-3 font-bold text-purple-600">{t.partner === 'Kamal' ? `₹${t.amount}` : '-'}</td>
                                                    <td className="p-3"><button onClick={() => setDeleteConfirm(t.id)} className="text-slate-300 hover:text-rose-500"><Icon name="trash-2" size={14} /></button></td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </main>

                    {/* Simple Toast */}
                    {toast && (
                        <div className="fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-2 rounded-full text-[10px] font-bold uppercase tracking-widest z-[100] shadow-2xl animate-bounce">
                            {toast}
                        </div>
                    )}

                    {/* Delete Confirmation */}
                    {deleteConfirm && (
                        <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[110] flex items-center justify-center p-4">
                            <div className="bg-white rounded-2xl p-6 max-w-xs w-full shadow-2xl">
                                <h3 className="font-bold mb-2">Confirm Delete?</h3>
                                <p className="text-xs text-slate-500 mb-6">This will remove the entry from all devices permanently.</p>
                                <div className="flex gap-2">
                                    <button onClick={() => setDeleteConfirm(null)} className="flex-1 py-2 bg-slate-100 rounded-lg text-xs font-bold">Cancel</button>
                                    <button onClick={confirmDelete} className="flex-1 py-2 bg-rose-600 text-white rounded-lg text-xs font-bold">Delete</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
