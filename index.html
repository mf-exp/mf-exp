<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motion Factory - Entry</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        :root {
            --primary: #2563eb;
            --secondary: #f97316; /* Kamal Color - Soft Orange */
            --bg-subtle: #f8fafc;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--bg-subtle);
            color: #1e293b;
        }

        .tab-active { 
            color: var(--primary); 
            background: rgba(37, 99, 235, 0.05);
            border-bottom: 3px solid var(--primary); 
        }

        .glass-card { 
            background: rgba(255, 255, 255, 0.8); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .input-focus {
            transition: all 0.2s ease;
        }

        .input-focus:focus {
            background: white;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
            transform: translateY(-1px);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin-fast {
            animation: spin 0.6s linear infinite;
        }

        @keyframes pulse-soft-fade {
            0% { transform: scale(1); opacity: 0; }
            20% { transform: scale(1.2); opacity: 1; }
            40% { transform: scale(1); opacity: 0.7; }
            60% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 0; }
        }
        .status-dot-active {
            animation: pulse-soft-fade 2s ease-in-out forwards;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center pb-8 selection:bg-blue-100 pt-4">

    <!-- Tabs Navigation -->
    <div class="w-full max-w-md px-4">
        <div class="w-full flex bg-white/50 p-1 rounded-xl border border-slate-100 shadow-sm">
            <button id="tabEntryBtn" class="flex-1 py-2 text-sm font-bold text-slate-500 rounded-lg transition-all tab-active flex items-center justify-center gap-2">
                <div id="connectionDot" class="w-2 h-2 rounded-full bg-red-500 animate-pulse ring-2 ring-red-500/10 shrink-0"></div>
                <span>New Entry</span>
            </button>
            <button id="tabHistoryBtn" class="flex-1 py-2 text-sm font-bold text-slate-500 rounded-lg transition-all flex items-center justify-center gap-2">
                <span>History</span>
                <div id="statusDot" class="w-2 h-2 rounded-full bg-emerald-500 opacity-0"></div>
            </button>
        </div>
    </div>

    <!-- Entry Tab -->
    <div id="viewEntry" class="w-full max-w-md px-4 mt-2">
        <div class="glass-card rounded-[2rem] shadow-xl shadow-blue-900/5 pt-0 px-6 pb-6">
            <form id="entryForm" class="space-y-4" style="margin-top: -20px;">
                <input type="hidden" id="editId">
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="block text-[10px] font-extrabold text-slate-400 uppercase tracking-widest px-1 pt-4">Date</label>
                        <input type="date" id="date" required class="w-full p-2.5 bg-slate-50/50 border border-slate-100 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm font-medium input-focus">
                    </div>
                    <div class="space-y-1">
                        <label class="block text-[10px] font-extrabold text-slate-400 uppercase tracking-widest px-1 pt-4">Amount</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-bold text-sm">₹</span>
                            <input type="number" id="amount" autofocus placeholder="0" required class="w-full p-2.5 pl-7 bg-slate-50/50 border border-slate-100 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm font-bold input-focus">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="block text-[10px] font-extrabold text-slate-400 uppercase tracking-widest px-1">Type</label>
                        <div class="grid grid-cols-2 gap-2">
                            <label>
                                <input type="radio" name="type" value="Expense" checked class="hidden peer">
                                <div class="text-center py-2 rounded-xl border-2 border-slate-50 bg-slate-50/50 text-slate-400 peer-checked:bg-red-50 peer-checked:border-red-500 peer-checked:text-red-600 cursor-pointer transition-all font-bold text-[11px]">
                                    Exp
                                </div>
                            </label>
                            <label>
                                <input type="radio" name="type" value="Income" class="hidden peer">
                                <div class="text-center py-2 rounded-xl border-2 border-slate-50 bg-slate-50/50 text-slate-400 peer-checked:bg-emerald-50 peer-checked:border-emerald-500 peer-checked:text-emerald-600 cursor-pointer transition-all font-bold text-[11px]">
                                    Inc
                                </div>
                            </label>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="block text-[10px] font-extrabold text-slate-400 uppercase tracking-widest px-1">Member</label>
                        <div class="grid grid-cols-2 gap-2">
                            <label>
                                <input type="radio" name="partner" value="Jaimin" checked class="hidden peer">
                                <div class="text-center py-2 rounded-xl border-2 border-slate-50 bg-slate-50/50 text-slate-400 peer-checked:bg-blue-50 peer-checked:border-blue-500 peer-checked:text-blue-600 cursor-pointer transition-all font-bold text-[11px]">
                                    J
                                </div>
                            </label>
                            <label>
                                <input type="radio" name="partner" value="Kamal" class="hidden peer">
                                <div class="text-center py-2 rounded-xl border-2 border-slate-50 bg-slate-50/50 text-slate-400 peer-checked:bg-orange-50 peer-checked:border-orange-500 peer-checked:text-orange-600 cursor-pointer transition-all font-bold text-[11px]">
                                    K
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="space-y-1">
                    <label class="block text-[10px] font-extrabold text-slate-400 uppercase tracking-widest px-1">Note</label>
                    <input type="text" id="note" required placeholder="What was this for?" class="w-full p-3 bg-slate-50/50 border border-slate-100 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm font-medium input-focus">
                </div>

                <div class="pt-2 flex gap-2">
                    <button type="submit" id="submitBtn" class="flex-[4] bg-blue-600 text-white font-extrabold py-4 rounded-2xl hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all active:scale-[0.97] flex items-center justify-center gap-2 disabled:opacity-80 disabled:cursor-not-allowed">
                        <div id="btnContent" class="flex items-center gap-2">
                            <span id="btnText">Save Record</span>
                            <svg id="btnIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path></svg>
                        </div>
                        <div id="btnLoader" class="hidden">
                            <svg class="w-5 h-5 animate-spin-fast" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>
                    </button>
                    <!-- Page Refresh Button -->
                    <button type="button" onclick="window.location.reload()" class="flex-1 bg-slate-100 text-slate-500 hover:bg-slate-200 hover:text-slate-700 rounded-2xl flex items-center justify-center transition-all active:scale-95 shadow-sm border border-slate-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    </button>
                </div>
                <button type="button" id="cancelEdit" class="w-full py-3 text-[10px] font-bold text-slate-400 hover:text-red-500 transition-colors hidden">Discard Changes</button>
            </form>
        </div>
    </div>

    <!-- History Tab -->
    <div id="viewHistory" class="w-full max-w-md px-4 mt-2 hidden">
        <!-- Controls Bar -->
        <div class="flex items-stretch justify-between mb-4 gap-2 h-10">
            <div class="flex-1 flex bg-slate-100 p-1 rounded-xl border border-slate-200 shadow-sm">
                <label class="flex-1 cursor-pointer">
                    <input type="radio" name="historySort" value="date" checked class="hidden peer">
                    <div class="h-full flex items-center justify-center rounded-lg text-xs font-bold text-slate-400 peer-checked:bg-white peer-checked:text-blue-600 peer-checked:shadow-sm transition-all uppercase tracking-wide">
                        Date
                    </div>
                </label>
                <label class="flex-1 cursor-pointer">
                    <input type="radio" name="historySort" value="recent" class="hidden peer">
                    <div class="h-full flex items-center justify-center rounded-lg text-xs font-bold text-slate-400 peer-checked:bg-white peer-checked:text-blue-600 peer-checked:shadow-sm transition-all uppercase tracking-wide">
                        Recent
                    </div>
                </label>
            </div>
            
            <!-- History Data Refresh Icon -->
            <button id="refreshHistoryBtn" class="w-10 flex items-center justify-center text-slate-500 hover:text-blue-600 bg-white rounded-xl border border-slate-200 shadow-sm active:scale-90 transition-all shrink-0">
                <svg id="refreshIconSvg" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
            </button>
        </div>
        
        <div class="space-y-1.5 custom-scrollbar pb-10" id="recentHistory">
            <p class="text-center text-slate-400 text-xs py-10 italic">Fetching logs...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, serverTimestamp, onSnapshot, getDocs, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCbub9ifyELCi9BhOYBeOFBYSf-UZAD7-I",
            authDomain: "mf-final.firebaseapp.com",
            projectId: "mf-final",
            storageBucket: "mf-final.firebasestorage.app",
            messagingSenderId: "20592787318",
            appId: "1:20592787318:web:a10c5d7e47e7cffc304457",
            measurementId: "G-N2YRN9JFXC"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'motion-factory-app';

        let currentUser = null;
        let allTransactions = [];
        let unsubscribeHistory = null;

        // Force focus on mount to trigger keyboard
        const forceInputFocus = () => {
            const amountInput = document.getElementById('amount');
            if (amountInput) {
                amountInput.focus();
                // Some Android webviews need a slight delay or a double focus
                setTimeout(() => amountInput.focus(), 100);
            }
        };

        document.getElementById('date').valueAsDate = new Date();
        window.onload = forceInputFocus;

        const tabEntryBtn = document.getElementById('tabEntryBtn');
        const tabHistoryBtn = document.getElementById('tabHistoryBtn');
        const viewEntry = document.getElementById('viewEntry');
        const viewHistory = document.getElementById('viewHistory');
        const statusDot = document.getElementById('statusDot');
        const refreshHistoryBtn = document.getElementById('refreshHistoryBtn');
        const refreshIconSvg = document.getElementById('refreshIconSvg');

        tabEntryBtn.onclick = () => {
            tabEntryBtn.classList.add('tab-active');
            tabHistoryBtn.classList.remove('tab-active');
            viewEntry.classList.remove('hidden');
            viewHistory.classList.add('hidden');
            forceInputFocus();
        };

        tabHistoryBtn.onclick = () => {
            tabHistoryBtn.classList.add('tab-active');
            tabEntryBtn.classList.remove('tab-active');
            viewHistory.classList.remove('hidden');
            viewEntry.classList.add('hidden');
            statusDot.classList.remove('status-dot-active');
        };

        async function initAuth() {
            try { await signInAnonymously(auth); } catch (e) {}
        }

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                document.getElementById('connectionDot').className = "w-2 h-2 rounded-full bg-emerald-500 ring-2 ring-emerald-500/10";
                setupHistoryListener();
            } else {
                initAuth();
            }
        });

        function setupHistoryListener() {
            if (unsubscribeHistory) unsubscribeHistory();
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'transactions');
            unsubscribeHistory = onSnapshot(q, (snapshot) => {
                allTransactions = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                sortAndRender();
            }, (err) => console.error(err));
        }

        refreshHistoryBtn.onclick = async () => {
            if (!currentUser) return;
            refreshIconSvg.classList.add('animate-spin-fast');
            refreshHistoryBtn.disabled = true;
            try {
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'));
                const snapshot = await getDocs(q);
                allTransactions = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                sortAndRender();
            } catch (err) {
                console.error("Manual refresh failed:", err);
            } finally {
                setTimeout(() => {
                    refreshIconSvg.classList.remove('animate-spin-fast');
                    refreshHistoryBtn.disabled = false;
                }, 500);
            }
        };

        const formatCurrency = (num) => {
            return new Intl.NumberFormat('en-IN').format(num);
        };

        document.querySelectorAll('input[name="historySort"]').forEach(radio => {
            radio.addEventListener('change', () => sortAndRender());
        });

        function sortAndRender() {
            const sortMode = document.querySelector('input[name="historySort"]:checked').value;
            allTransactions.sort((a, b) => {
                if (sortMode === 'date') {
                    const dateDiff = new Date(b.date) - new Date(a.date);
                    if (dateDiff !== 0) return dateDiff;
                    return (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
                } else {
                    return (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
                }
            });
            renderHistory();
        }

        function renderHistory() {
            const historyContainer = document.getElementById('recentHistory');
            if (allTransactions.length === 0) {
                historyContainer.innerHTML = `
                    <div class="text-center py-10 bg-white/50 rounded-2xl border-2 border-dashed border-slate-200">
                        <p class="text-slate-400 text-[10px] font-bold uppercase tracking-wider">No records found</p>
                    </div>
                `;
                return;
            }
            historyContainer.innerHTML = allTransactions.map(t => {
                const initial = t.partner ? t.partner.charAt(0).toUpperCase() : '?';
                const avatarBg = t.partner === 'Jaimin' ? 'bg-blue-600' : 'bg-orange-500';
                const typeAmountColor = t.type === 'Income' ? 'text-emerald-600' : 'text-red-500';
                const amountPrefix = t.type === 'Income' ? '+' : '-';
                const dateObj = new Date(t.date);
                const day = String(dateObj.getDate()).padStart(2, '0');
                const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                const month = monthNames[dateObj.getMonth()];
                const displayDate = `${day}-${month}`;
                return `
                <div class="glass-card px-3 py-1.5 rounded-xl shadow-sm border border-slate-50 flex items-center justify-between gap-2">
                    <div class="flex items-center gap-2 flex-1 min-w-0">
                        <div class="flex-shrink-0 w-8 h-8 ${avatarBg} text-white rounded-lg flex items-center justify-center font-black text-[12px] shadow-sm">
                            ${initial}
                        </div>
                        <div class="flex items-center gap-2 min-w-0">
                            <span class="text-[11px] font-extrabold text-slate-400 tracking-tighter shrink-0">${displayDate}</span>
                            <p class="text-[13px] text-slate-800 font-bold truncate pr-1 leading-none">${t.note}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="text-right">
                            <p class="font-black text-[14px] ${typeAmountColor} whitespace-nowrap tracking-tight">
                                ${amountPrefix}₹${formatCurrency(t.amount)}
                            </p>
                        </div>
                        <div class="flex gap-1 border-l border-slate-100 pl-2">
                            <button onclick="window.editEntry('${t.id}')" class="p-1.5 text-blue-600 bg-blue-50/50 rounded-lg active:scale-90 transition-all">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                            </button>
                            <button onclick="window.deleteEntry('${t.id}')" class="p-1.5 text-red-400 bg-red-50/50 rounded-lg active:scale-90 transition-all">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        window.deleteEntry = async (id) => {
            if (!confirm("Delete permanently?")) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'transactions', id));
                showStatusSignal();
            } catch (e) { console.error(e); }
        };

        window.editEntry = (id) => {
            const t = allTransactions.find(x => x.id === id);
            if (!t) return;
            document.getElementById('editId').value = t.id;
            document.getElementById('date').value = t.date;
            document.getElementById('amount').value = t.amount;
            document.getElementById('note').value = t.note;
            document.querySelector(`input[name="type"][value="${t.type}"]`).checked = true;
            document.querySelector(`input[name="partner"][value="${t.partner}"]`).checked = true;
            document.getElementById('btnText').textContent = "Update Entry";
            document.getElementById('btnIcon').innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>`;
            document.getElementById('cancelEdit').classList.remove('hidden');
            tabEntryBtn.click();
        };

        document.getElementById('cancelEdit').onclick = () => {
            document.getElementById('entryForm').reset();
            document.getElementById('editId').value = "";
            document.getElementById('btnText').textContent = "Save Record";
            document.getElementById('btnIcon').innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path>`;
            document.getElementById('cancelEdit').classList.add('hidden');
            document.getElementById('date').valueAsDate = new Date();
            forceInputFocus();
        };

        const showStatusSignal = () => {
            statusDot.classList.remove('status-dot-active');
            void statusDot.offsetWidth; 
            statusDot.classList.add('status-dot-active');
        };

        document.getElementById('entryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;
            const submitBtn = document.getElementById('submitBtn');
            const btnContent = document.getElementById('btnContent');
            const btnLoader = document.getElementById('btnLoader');
            const editId = document.getElementById('editId').value;
            submitBtn.disabled = true;
            btnContent.classList.add('hidden');
            btnLoader.classList.remove('hidden');
            const data = {
                date: document.getElementById('date').value,
                amount: parseFloat(document.getElementById('amount').value),
                type: document.querySelector('input[name="type"]:checked').value,
                partner: document.querySelector('input[name="partner"]:checked').value,
                note: document.getElementById('note').value,
                updatedAt: serverTimestamp()
            };
            try {
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'transactions');
                if (editId) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'transactions', editId), data);
                    showStatusSignal();
                    document.getElementById('cancelEdit').click();
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(colRef, data);
                    showStatusSignal();
                    document.getElementById('entryForm').reset();
                    document.getElementById('date').valueAsDate = new Date();
                    forceInputFocus();
                }
            } catch (err) { console.error(err); }
            finally { 
                submitBtn.disabled = false;
                btnContent.classList.remove('hidden');
                btnLoader.classList.add('hidden');
            }
        });

        initAuth();
    </script>
</body>
</html>
