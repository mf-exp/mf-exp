<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Motion Factory Manager</title>
    
    <!-- PWA & Android App Meta Tags -->
    <meta name="theme-color" content="#0f172a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/599/599370.png">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #f8fafc;
            overscroll-behavior-y: contain; /* Prevents pull-to-refresh in app mode */
        }
        /* Mobile optimization: make tap targets larger */
        button, input {
            min-height: 44px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- PWA AUTO-MANIFEST GENERATOR ---
        // This tells Android how to show the app on your home screen
        const initPWA = () => {
            const manifest = {
                "name": "Motion Factory Manager",
                "short_name": "MF Manager",
                "start_url": ".",
                "display": "standalone",
                "background_color": "#ffffff",
                "theme_color": "#0f172a",
                "icons": [{
                    "src": "https://cdn-icons-png.flaticon.com/512/599/599370.png",
                    "sizes": "512x512",
                    "type": "image/png"
                }]
            };
            const stringManifest = JSON.stringify(manifest);
            const blob = new Blob([stringManifest], {type: 'application/json'});
            const manifestURL = URL.createObjectURL(blob);
            document.querySelector('head').insertAdjacentHTML('beforeend', `<link rel="manifest" href="${manifestURL}">`);
        };
        initPWA();

        // =========================================================
        // STEP 1: PASTE YOUR FIREBASE CONFIGURATION BELOW
        // =========================================================
        const firebaseConfig = {
    apiKey: "AIzaSyCbub9ifyELCi9BhOYBeOFBYSf-UZAD7-I",
    authDomain: "mf-final.firebaseapp.com",
    projectId: "mf-final",
    storageBucket: "mf-final.firebasestorage.app",
    messagingSenderId: "20592787318",
    appId: "1:20592787318:web:a10c5d7e47e7cffc304457",
    measurementId: "G-N2YRN9JFXC"
  }; 

        // =========================================================
        // END OF CONFIGURATION - DO NOT EDIT BELOW THIS LINE
        // =========================================================

        try {
            if (typeof __firebase_config !== 'undefined' && !firebaseConfig) {
                firebaseConfig = JSON.parse(__firebase_config);
            }
        } catch (e) { 
            firebaseConfig = null; 
        }

        function App() {
            const [currentUser, setCurrentUser] = useState(null);
            const [selectedRole, setSelectedRole] = useState('Jaimin');
            const [password, setPassword] = useState('');
            const [loginError, setLoginError] = useState('');
            const [transactions, setTransactions] = useState([]);
            const [note, setNote] = useState('');
            const [amount, setAmount] = useState('');

            const PASSWORDS = {
                'Jaimin': 'jaimin123',
                'Kamal': 'kamal123'
            };

            if (!firebaseConfig) {
                return (
                    <div className="min-h-screen bg-slate-50 flex items-center justify-center p-6">
                        <div className="bg-white p-8 rounded-3xl shadow-xl max-w-md border-t-8 border-amber-500 text-center">
                            <h2 className="text-2xl font-black text-slate-800 mb-4">Cloud Setup Required</h2>
                            <p className="text-slate-600 mb-6">To run this as an <b>Android App</b>, you must first add your Firebase keys in Step 1 of the code.</p>
                        </div>
                    </div>
                );
            }

            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'motion-factory-ledger';

            useEffect(() => {
                const savedUser = localStorage.getItem('mf_user');
                if (savedUser) setCurrentUser(savedUser);
                firebase.auth().signInAnonymously().catch(err => console.error("Login failed", err));
            }, []);

            useEffect(() => {
                if (!currentUser) return;
                const unsubscribe = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('ledger')
                    .onSnapshot(snapshot => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setTransactions(data.sort((a, b) => new Date(b.date) - new Date(a.date)));
                    }, err => {
                        console.error("Firestore error", err);
                    });
                return () => unsubscribe();
            }, [currentUser]);

            const handleLogin = (e) => {
                e.preventDefault();
                if (password === PASSWORDS[selectedRole]) {
                    setCurrentUser(selectedRole);
                    localStorage.setItem('mf_user', selectedRole);
                    setLoginError('');
                } else {
                    setLoginError('Wrong password for ' + selectedRole);
                }
            };

            const addEntry = async () => {
                if (!note || !amount) return;
                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('ledger').add({
                        date: new Date().toISOString().split('T')[0],
                        note: note,
                        amount: parseFloat(amount),
                        partner: currentUser,
                        type: 'expense'
                    });
                    setNote('');
                    setAmount('');
                } catch (err) {
                    alert("Error saving: " + err.message);
                }
            };

            const logout = () => {
                localStorage.removeItem('mf_user');
                setCurrentUser(null);
                setPassword('');
            };

            if (!currentUser) {
                return (
                    <div className="min-h-screen bg-slate-900 flex items-center justify-center p-6">
                        <div className="max-w-md w-full bg-white rounded-3xl p-8 shadow-2xl text-center">
                            <h1 className="text-2xl font-black mb-6">MOTION FACTORY</h1>
                            <div className="flex gap-2 mb-6 bg-slate-100 p-1 rounded-xl">
                                <button onClick={() => setSelectedRole('Jaimin')} className={`flex-1 py-2 rounded-lg font-bold transition ${selectedRole === 'Jaimin' ? 'bg-white shadow text-blue-600' : 'text-slate-400'}`}>Jaimin</button>
                                <button onClick={() => setSelectedRole('Kamal')} className={`flex-1 py-2 rounded-lg font-bold transition ${selectedRole === 'Kamal' ? 'bg-white shadow text-purple-600' : 'text-slate-400'}`}>Kamal</button>
                            </div>
                            <form onSubmit={handleLogin} className="space-y-4">
                                <input type="password" border-2 className="w-full border-2 p-3 rounded-xl outline-none focus:border-slate-900" placeholder={`Password for ${selectedRole}`} value={password} onChange={e => setPassword(e.target.value)} />
                                {loginError && <p className="text-red-500 text-xs">{loginError}</p>}
                                <button type="submit" className="w-full bg-slate-900 text-white font-bold py-3 rounded-xl">Login as {selectedRole}</button>
                            </form>
                        </div>
                    </div>
                );
            }

            return (
                <div className="p-4 max-w-2xl mx-auto">
                    <div className="flex justify-between items-center mb-8">
                        <div>
                            <h1 className="text-xl font-black">MF MANAGER</h1>
                            <p className="text-[10px] font-bold text-slate-400 uppercase">Logged in: <span className="text-slate-900">{currentUser}</span></p>
                        </div>
                        <button onClick={logout} className="text-[10px] font-bold text-rose-500 uppercase border border-rose-100 px-3 py-1 rounded-full">Logout</button>
                    </div>
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 mb-6">
                        <h2 className="font-bold mb-4 text-sm uppercase text-slate-400">Add New Entry</h2>
                        <div className="space-y-3">
                            <input type="text" placeholder="Description (e.g. Petrol)" className="w-full border p-3 rounded-xl outline-none focus:ring-2 focus:ring-slate-100" value={note} onChange={e => setNote(e.target.value)} />
                            <input type="number" placeholder="Amount (₹)" className="w-full border p-3 rounded-xl outline-none focus:ring-2 focus:ring-slate-100" value={amount} onChange={e => setAmount(e.target.value)} />
                            <button onClick={addEntry} className="w-full bg-slate-900 text-white py-3 rounded-xl font-bold">Save as {currentUser}</button>
                        </div>
                    </div>
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <h2 className="font-bold mb-4 text-sm uppercase text-slate-400">History</h2>
                        <div className="space-y-4">
                            {transactions.map(t => (
                                <div key={t.id} className="flex justify-between items-center border-b border-slate-50 pb-3">
                                    <div>
                                        <p className="text-sm font-bold text-slate-800">{t.note}</p>
                                        <p className="text-[10px] text-slate-400 font-bold uppercase">{t.partner} • {t.date}</p>
                                    </div>
                                    <span className="text-rose-600 font-black">₹{t.amount}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
